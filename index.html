<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Grafici + Sentiment v5.1</title>
    <link rel="icon" href="favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: #f0f2f5;
        }
        .brand-yellow { background-color: #ffc72c; }
        .brand-blue { background-color: #0431AE; }
        .text-brand-blue { color: #0431AE; }
        .border-brand-blue { border-color: #0431AE; }
        
        /* Stili Radio Button Grafici */
        .custom-radio input[type="radio"] { display: none; }
        .custom-radio label { transition: all 0.2s ease-in-out; }
        .custom-radio input[type="radio"]:checked + label {
            border-color: #0431AE;
            background-color: #e0e7ff;
            color: #0431AE;
            font-weight: 700;
        }
        svg text { user-select: none; }
        
        /* Bottoni Toggle */
        .input-toggle-btn.active {
            background-color: #e0e7ff;
            color: #0431AE;
            font-weight: 700;
            border-color: #0431AE;
            z-index: 10;
        }
        .input-toggle-btn.inactive {
            background-color: #f8f9fa;
            color: #6c757d;
            border-color: #dee2e6;
        }

        /* --- STILI TABELLA TIPO EXCEL (GRID) --- */
        #manual-data-container {
            border: 1px solid #9ca3af;
            background-color: #fff;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .data-row {
            display: flex;
            width: 100%;
            border-bottom: 1px solid #cbd5e1;
        }
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-row input {
            border: none;
            border-radius: 0;
            padding: 8px 12px;
            font-size: 0.95rem;
            outline: none;
            background: transparent;
            transition: background 0.2s;
        }

        .data-row .data-label {
            border-right: 1px solid #cbd5e1; 
            background-color: #fff;
        }
        .data-row .data-value {
            background-color: #fff;
        }

        .data-row input:focus {
            background-color: #eff6ff;
            box-shadow: inset 0 0 0 2px #0431AE;
            z-index: 10;
        }
        .data-row:hover .data-label, 
        .data-row:hover .data-value {
            background-color: #f8fafc;
        }

        /* Stili Accordion */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep {
            0%    {opacity: 0; transform: translateY(-10px)}
            100%  {opacity: 1; transform: translateY(0)}
        }
        .accordion-arrow { transition: transform 0.2s; }
        details[open] .accordion-arrow { transform: rotate(180deg); }
    </style>
</head>
<body class="antialiased text-gray-800">

    <header class="brand-yellow p-4 shadow-md sticky top-0 z-50">
        <h1 class="text-3xl font-bold text-brand-blue text-center">Generatore Grafici</h1>
    </header>

    <main class="container mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-4 space-y-3 h-fit">
            
            <div class="bg-white p-4 rounded-lg shadow-md border border-gray-100">
                <h2 class="text-lg font-bold text-brand-blue mb-3">1. Tipo di grafico</h2>
                <div class="grid grid-cols-3 gap-2 custom-radio">
                    <div>
                        <input type="radio" id="histogram" name="chart_type" value="histogram" checked class="chart-type-selector">
                        <label for="histogram" class="cursor-pointer border border-gray-200 rounded-md p-2 text-center block hover:border-blue-400 text-xs flex items-center justify-center h-full">Istogramma</label>
                    </div>
                    <div>
                        <input type="radio" id="pie_chart" name="chart_type" value="pie" class="chart-type-selector">
                        <label for="pie_chart" class="cursor-pointer border border-gray-200 rounded-md p-2 text-center block hover:border-blue-400 text-xs flex items-center justify-center h-full">Torta / Anello</label>
                    </div>
                    <div>
                        <input type="radio" id="sentiment_bar" name="chart_type" value="sentiment_bar" class="chart-type-selector">
                        <label for="sentiment_bar" class="cursor-pointer border border-gray-200 rounded-md p-2 text-center block hover:border-blue-400 text-xs flex items-center justify-center h-full">Barra Sentiment</label>
                    </div>
                </div>
            </div>

            <details class="bg-white rounded-lg shadow-md border border-gray-100 group" open>
                <summary class="cursor-pointer p-4 bg-gray-50 rounded-t-lg hover:bg-gray-100 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-brand-blue">2. Dati e Contenuto</h2>
                    <svg class="w-5 h-5 text-gray-500 accordion-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="p-4 border-t border-gray-200">
                    <div class="space-y-4">
                        <div>
                            <label for="chart-title" class="block text-sm font-medium text-gray-700 mb-1">Titolo del Grafico</label>
                            <input type="text" id="chart-title" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Es. Sentiment Analisi">
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="w-1/2 pr-2">
                                <label for="font-size-title" class="block text-sm font-medium text-gray-700">Font Titolo</label>
                                <input type="number" id="font-size-title" value="32" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div class="w-1/2 pl-2 flex items-center mt-6">
                                <input id="hide-title-toggle" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="hide-title-toggle" class="ml-2 block text-sm text-gray-900">Nascondi</label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Inserimento Dati</label>
                            <div class="flex rounded-md shadow-sm">
                                <button id="toggle-manual-btn" type="button" class="input-toggle-btn active w-1/2 relative inline-flex items-center justify-center p-2 rounded-l-md border text-sm font-medium focus:outline-none">Griglia (Manuale)</button>
                                <button id="toggle-paste-btn" type="button" class="input-toggle-btn inactive -ml-px w-1/2 relative inline-flex items-center justify-center p-2 rounded-r-md border text-sm font-medium focus:outline-none">Incolla Testo</button>
                            </div>
                        </div>
                        
                        <div id="manual-entry-wrapper" style="display: block;">
                            <div class="flex gap-0 mb-1 px-0">
                                <div class="w-2/3 text-xs font-bold text-gray-500 uppercase tracking-wider pl-2">Etichetta</div>
                                <div class="w-1/3 text-xs font-bold text-gray-500 uppercase tracking-wider pl-2">Valore</div>
                            </div>
                            
                            <div id="manual-data-container" class="max-h-64 overflow-y-auto shadow-sm">
                            </div>
                            
                            <button type="button" id="add-row-btn" class="mt-2 w-full text-sm text-brand-blue font-semibold py-2 px-4 rounded-md border border-dashed border-blue-200 bg-blue-50 hover:bg-blue-100 transition-colors">
                                + Aggiungi Riga
                            </button>
                        </div>

                        <div id="paste-data-container" style="display: none;">
                            <label for="data-paste" class="block text-xs text-gray-500 mb-1">Copia da Excel e incolla qui (Label [TAB] Valore)</label>
                            <textarea id="data-paste" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm font-mono" placeholder="Positivo	50&#10;Neutro	30&#10;Negativo	20"></textarea>
                        </div>

                        <div class="relative py-2">
                            <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center">
                                <span class="bg-white px-2 text-xs text-gray-500">OPPURE</span>
                            </div>
                        </div>
                        
                        <div>
                            <label for="file-upload" class="w-full inline-block text-center px-4 py-2 border border-dashed border-gray-400 rounded-md cursor-pointer hover:bg-gray-50 transition-colors">
                                <span id="file-label" class="text-sm text-gray-600">Carica file Excel (.xlsx)</span>
                                <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls">
                            </label>
                        </div>
                    </div>
                </div>
            </details>

            <details class="bg-white rounded-lg shadow-md border border-gray-100 group">
                <summary class="cursor-pointer p-4 bg-gray-50 rounded-t-lg hover:bg-gray-100 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-brand-blue">3. Personalizzazione</h2>
                    <svg class="w-5 h-5 text-gray-500 accordion-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="p-4 border-t border-gray-200">
                    
                    <div id="histogram-options">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Larghezza</label>
                                    <input type="number" id="chart-width" value="800" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Altezza</label>
                                    <input type="number" id="chart-height" value="500" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Schema Colori</label>
                                <select id="histogram-color-scheme" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <option value="blue" data-main="#bfd7fd" data-highlight="#0431AE">Blu (Default)</option>
                                    <option value="yellow" data-main="#eedf4a" data-highlight="#faee80">Giallo</option>
                                </select>
                            </div>
                            <div id="histogram-yellow-outline-container" style="display: none;">
                                <div class="flex items-center">
                                    <input id="histogram-yellow-outline" type="checkbox" class="h-4 w-4 text-blue-600 rounded">
                                    <label for="histogram-yellow-outline" class="ml-2 text-sm text-gray-900">Aggiungi outline blu</label>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Orientamento</label>
                                    <select id="chart-orientation" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md text-sm">
                                        <option value="vertical" selected>Verticale</option>
                                        <option value="horizontal">Orizzontale</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Spaziatura Barre</label>
                                    <select id="histogram-padding" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md text-sm">
                                        <option value="0.1">Molto Stretta</option>
                                        <option value="0.2">Stretta</option>
                                        <option value="0.4" selected>Normale</option>
                                        <option value="0.6">Larga</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <input id="hide-value-axis-toggle" type="checkbox" class="h-4 w-4 text-blue-600 rounded">
                                <label for="hide-value-axis-toggle" class="ml-2 text-sm text-gray-900">Nascondi asse valori (solo orizz.)</label>
                            </div>
                             <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Font Assi</label>
                                    <input type="number" id="font-size-x" value="12" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Font Valori</label>
                                    <input type="number" id="font-size-y" value="12" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                </div>
                            </div>
                             <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Decimali</label>
                                    <select id="histogram-decimals" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2" selected>2</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Stile Valori</label>
                                    <select id="histogram-label-weight" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="900" selected>Bold</option>
                                        <option value="400">Light</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Ordina</label>
                                    <select id="sort-by" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="none" selected>Nessuno</option>
                                        <option value="label">Etichetta</option>
                                        <option value="value">Valore</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Direzione</label>
                                    <select id="sort-direction" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="asc">Crescente</option>
                                        <option value="desc" selected>Decrescente</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="pie-chart-options" style="display: none;">
                        <div class="mb-4">
                             <button id="shuffle-visual-btn" class="w-full bg-indigo-50 text-indigo-700 font-bold py-2 px-4 rounded-lg hover:bg-indigo-100 transition-colors border border-indigo-200 flex items-center justify-center gap-2 text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Cambia ordine visivo (Random)
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <input id="pie-donut-toggle" type="checkbox" class="h-4 w-4 text-blue-600 rounded">
                                <label for="pie-donut-toggle" class="ml-2 text-sm text-gray-900">Grafico ad anello</label>
                            </div>
                            <div id="pie-donut-size-container" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700">Spessore</label>
                                <select id="pie-donut-size" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <option value="stretto">Stretto</option>
                                    <option value="medio" selected>Medio</option>
                                    <option value="largo">Largo</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Colori</label>
                                <select id="pie-color-scheme" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <option value="multi" selected>Multi Colore</option>
                                    <option value="mono">Monocolore</option>
                                    <option value="two">2 Colori</option>
                                    <option value="sentiment">Sentiment (con Legenda in basso)</option>
                                </select>
                            </div>
                             <div id="pie-mono-color-container" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700">Seleziona Colore</label>
                                <select id="pie-mono-color" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md text-sm">
                                </select>
                            </div>
                            <div id="pie-two-color-container" style="display: none;">
                                 <label class="block text-sm font-medium text-gray-700">Schema Bicolore</label>
                                 <select id="pie-two-color-scheme" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    <option value="blue" data-main="#bfd7fd" data-highlight="#0431AE">Blu (Default)</option>
                                    <option value="yellow" data-main="#eedf4a" data-highlight="#faee80">Giallo</option>
                                </select>
                                <div class="flex items-center mt-2">
                                    <input id="pie-invert-colors" type="checkbox" class="h-4 w-4 text-blue-600 rounded">
                                    <label for="pie-invert-colors" class="ml-2 text-sm text-gray-900">Inverti Colori</label>
                                </div>
                            </div>
                            <div>
                                <div id="pie-smart-sort-container" class="flex items-center">
                                    <input id="pie-smart-sort" type="checkbox" class="h-4 w-4 text-blue-600 rounded" checked>
                                    <label for="pie-smart-sort" class="ml-2 text-xs text-gray-900">Evita sovrapposizioni (Smart Sort)</label>
                                </div>
                                <div id="pie-shuffle-colors-container" class="flex items-center mt-2">
                                    <input id="pie-shuffle-colors" type="checkbox" class="h-4 w-4 text-blue-600 rounded">
                                    <label for="pie-shuffle-colors" class="ml-2 text-xs text-gray-900">Evita colori simili vicini</label>
                                </div>
                            </div>
                             <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Formato</label>
                                    <select id="pie-label-format" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="percentage" selected>%</option>
                                        <option value="absolute">Valore</option>
                                    </select>
                                </div>
                                 <div id="pie-decimals-container">
                                    <label class="block text-xs font-medium text-gray-700">Decimali</label>
                                    <select id="pie-decimals" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="0">0</option>
                                        <option value="1" selected>1</option>
                                        <option value="2">2</option>
                                    </select>
                                </div>
                             </div>
                             
                             <div class="grid grid-cols-2 gap-3">
                                 <div>
                                    <label class="block text-xs font-medium text-gray-700">Colore Etichette</label>
                                    <select id="pie-label-color" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="blue" selected>Blu</option>
                                        <option value="gray">Grigio</option>
                                    </select>
                                </div>
                                 <div>
                                    <label class="block text-xs font-medium text-gray-700">Font Size</label>
                                    <input type="number" id="pie-font-size-labels" value="28" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                </div>
                            </div>
                             <div>
                                <label class="block text-xs font-medium text-gray-700">Stile Font</label>
                                <select id="pie-label-weight" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                    <option value="900">Grassetto</option>
                                    <option value="400" selected>Normale</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="sentiment-bar-options" style="display: none;">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Larghezza Totale</label>
                                    <input type="number" id="sentiment-width" value="800" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Altezza Barra</label>
                                    <input type="number" id="sentiment-height" value="60" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                </div>
                            </div>
                             <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Decimali %</label>
                                    <select id="sentiment-decimals" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                        <option value="0">0</option>
                                        <option value="1" selected>1</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Font Etichette</label>
                                    <input type="number" id="sentiment-label-font-size" value="20" class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </details>

            <details class="bg-white rounded-lg shadow-md border border-gray-100 group">
                <summary class="cursor-pointer p-4 bg-gray-50 rounded-t-lg hover:bg-gray-100 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-brand-blue">4. Azioni</h2>
                    <svg class="w-5 h-5 text-gray-500 accordion-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                <div class="p-4 border-t border-gray-200">
                     <div class="flex flex-col space-y-3">
                        <button id="generate-btn" class="w-full brand-blue text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-opacity shadow-sm">
                            Genera Grafico
                        </button>
                        <button id="download-btn" disabled class="w-full bg-gray-300 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed transition-colors">
                            Salva Immagine (SVG)
                        </button>
                        <div class="grid grid-cols-2 gap-3 pt-2">
                             <button id="save-settings-btn" class="w-full bg-white text-gray-600 border border-gray-300 font-semibold py-2 px-2 rounded-lg hover:bg-gray-50 text-xs">
                                Salva Config
                            </button>
                            <label for="load-settings-input" class="w-full text-center bg-white text-gray-600 border border-gray-300 font-semibold py-2 px-2 rounded-lg hover:bg-gray-50 text-xs cursor-pointer flex items-center justify-center">
                                Carica Config
                                <input type="file" id="load-settings-input" class="hidden" accept=".json">
                            </label>
                        </div>
                     </div>
                </div>
            </details>

        </div>

        <div class="lg:col-span-8 bg-white p-4 md:p-6 rounded-lg shadow-lg flex flex-col items-center justify-start min-h-[600px] border border-gray-100">
            <div id="chart-container" class="w-full h-full flex items-center justify-center">
                <div id="placeholder" class="text-gray-400 flex flex-col items-center justify-center h-full">
                    <div class="bg-gray-50 p-6 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    </div>
                    <p class="text-lg font-medium text-gray-500">L'anteprima del grafico apparirà qui.</p>
                    <p class="text-sm text-gray-400 mt-2">Compila i dati a sinistra e clicca "Genera Grafico"</p>
                </div>
            </div>
             <p id="feedback-message" class="mt-4 text-green-600 font-semibold h-6"></p>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const allInputs = Array.from(document.querySelectorAll('input, select, textarea'));
            const chartTypeSelectors = document.querySelectorAll('.chart-type-selector');
            const histogramOptions = document.getElementById('histogram-options');
            const pieChartOptions = document.getElementById('pie-chart-options');
            const sentimentBarOptions = document.getElementById('sentiment-bar-options'); 
            const generateBtn = document.getElementById('generate-btn');
            const downloadBtn = document.getElementById('download-btn');
            const chartContainer = document.getElementById('chart-container');
            const fileUpload = document.getElementById('file-upload');
            const fileLabel = document.getElementById('file-label');
            const feedbackMessage = document.getElementById('feedback-message');
            const togglePasteBtn = document.getElementById('toggle-paste-btn');
            const toggleManualBtn = document.getElementById('toggle-manual-btn');
            const pasteDataContainer = document.getElementById('paste-data-container');
            const manualEntryWrapper = document.getElementById('manual-entry-wrapper');
            const manualDataContainer = document.getElementById('manual-data-container');
            const dataPaste = document.getElementById('data-paste');
            const addRowBtn = document.getElementById('add-row-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const loadSettingsInput = document.getElementById('load-settings-input');
            const pieColorScheme = document.getElementById('pie-color-scheme');
            const pieTwoColorContainer = document.getElementById('pie-two-color-container');
            const pieMonoColorSelect = document.getElementById('pie-mono-color');
            const histogramColorScheme = document.getElementById('histogram-color-scheme');
            const histogramYellowOutlineContainer = document.getElementById('histogram-yellow-outline-container');
            const shuffleVisualBtn = document.getElementById('shuffle-visual-btn');

            let activeVisualShuffleIndices = null;

            // --- SOCIAL ICONS PATHS & COLORS ---
            const SOCIAL_ICONS = {
                x: "M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z",
                facebook: "M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z",
                instagram: "M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z",
                tiktok: "M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93v6.16c0 2.52-1.12 4.84-2.91 6.35-1.78 1.51-4.19 2.16-6.42 1.71-2.05-.38-3.9-1.58-5.06-3.26-1.17-1.68-1.5-3.83-0.87-5.8 0.58-1.84 2.05-3.32 3.9-3.95 0.53-.19 1.09-.32 1.66-.37v4.06c-1.07.12-1.95.89-2.17 1.93-.21 1.03.35 2.07 1.29 2.57.94.51 2.11.3 2.89-.47.63-.61.98-1.47.98-2.35v-14.7h2.64z",
                youtube: "M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z",
                linkedin: "M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h5v-8.368c0-4.754 5.922-5.226 5.922 0v8.368h5v-9.319c0-6.17-6.936-6.059-8.498-3.08v-3.569h-2.456z",
                web: "M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0z M12 2.2C16.8 2.2 20.8 5.6 21.7 10h-5.2C16.1 7.1 15.2 4.6 14 2.5 13.4 2.3 12.7 2.2 12 2.2z M12 21.8c-0.7 0-1.4-0.1-2-0.3 1.2-2.1 2.1-4.6 2.5-7.5h5.2C16.8 18.4 12.8 21.8 12 21.8z M2.3 10h5.2c0.4-2.9 1.3-5.4 2.5-7.5 -0.6-0.2-1.3-0.3-2-0.3C4.2 2.2 0.2 5.6 2.3 10z M2.3 14c-2.1 4.4 1.9 7.8 5.7 7.8 0.7 0 1.4-0.1 2-0.3 -1.2-2.1-2.1-4.6-2.5-7.5H2.3z M12 12c0-0.7 0-1.4 0.1-2h4.8c0.1 0.6 0.1 1.3 0.1 2s0 1.4-0.1 2h-4.8C12 13.4 12 12.7 12 12z M9.9 10c0.1-0.7 0.1-1.3 0.1-2H7.1C7 8.6 7 9.3 7 10H9.9z M9.9 14H7.1c0 0.7 0 1.4 0.1 2h2.7C9.9 15.4 9.9 14.7 9.9 14z",
                dots: "M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"
            };

            const ICON_COLORS = {
                x: "#000000",
                facebook: "#1877F2",
                instagram: "#E1306C",
                tiktok: "#000000",
                youtube: "#FF0000",
                linkedin: "#0A66C2",
                web: "#5F6368",
                dots: "#5F6368"
            };

            const getIconInfo = (rawLabel) => {
                const l = rawLabel.toLowerCase().trim();
                let key = null;
                if (l === 'x' || l === 'twitter' || l.includes('twitter')) key = 'x';
                else if (l.includes('facebook') || l === 'fb' || l === 'meta') key = 'facebook';
                else if (l.includes('instagram') || l === 'ig') key = 'instagram';
                else if (l.includes('tiktok')) key = 'tiktok';
                else if (l.includes('youtube') || l === 'yt') key = 'youtube';
                else if (l.includes('linkedin')) key = 'linkedin';
                else if (l.includes('web') || l.includes('sito') || l.includes('news') || l.includes('online')) key = 'web';
                else if (l.includes('altro') || l.includes('other') || l === '...') key = 'dots';
                
                if (key) return { path: SOCIAL_ICONS[key], color: ICON_COLORS[key] };
                return null;
            };

            const COLORS = {
                titleBlue: '#0431AE', barBlue: '#bfd7fd', axisGray: '#7b7b7a', gridGray: '#e0e0e0',
                labelGray: '#7b7b7a',
                sentiment: { positive: '#28a745', neutral: '#ffc107', negative: '#dc3545', default: '#a9c2ef' },
                multiPie: ['#1a2b92', '#1733ae', '#2e69b6', '#4180d0', '#5c95dd', '#7da9e6', '#97bdee', '#a9c2ef', '#c4d6f3', '#d2e0f7', '#e1eafb', '#f0f4fc']
            };

            const itLocale = d3.formatLocale({ decimal: ",", thousands: ".", grouping: [3], currency: ["€", ""] });
            
            const monoPieColors = [
                { name: 'Azzurro', value: '#a9c2ef' }, { name: 'Celeste', value: '#d2e0f7' },
                { name: 'Blu', value: '#4180d0' }, { name: 'Giallo Poste', value: '#ebdb49' },
                { name: 'Giallo Chiaro', value: '#fdf5a9' }
            ];

            if (pieMonoColorSelect) {
                pieMonoColorSelect.innerHTML = '';
                monoPieColors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color.value;
                    option.textContent = color.name;
                    option.style.backgroundColor = color.value;
                    const r = parseInt(color.value.substring(1, 3), 16), g = parseInt(color.value.substring(3, 5), 16), b = parseInt(color.value.substring(5, 7), 16);
                    if ((0.299 * r + 0.587 * g + 0.114 * b) < 128) option.style.color = 'white';
                    pieMonoColorSelect.appendChild(option);
                });
            }

            const styleColorSelector = (selectorId) => {
                const select = document.getElementById(selectorId);
                if (!select) return;
                Array.from(select.options).forEach(option => {
                    const mainColor = option.dataset.main;
                    const highlightColor = option.dataset.highlight;
                    if (!mainColor || !highlightColor) return;
                    option.style.background = `linear-gradient(to right, ${mainColor} 70%, ${highlightColor} 30%)`;
                    const hex = highlightColor.replace('#', '');
                    const r = parseInt(hex.substring(0, 2), 16), g = parseInt(hex.substring(2, 4), 16), b = parseInt(hex.substring(4, 6), 16);
                    if ((0.299 * r + 0.587 * g + 0.114 * b) > 150) {
                        option.style.color = 'black';
                    } else {
                        option.style.color = 'white';
                    }
                });
            };
            styleColorSelector('histogram-color-scheme');
            styleColorSelector('pie-two-color-scheme');
            
            histogramColorScheme.addEventListener('change', (e) => {
                histogramYellowOutlineContainer.style.display = e.target.value === 'yellow' ? 'block' : 'none';
            });

            togglePasteBtn.addEventListener('click', () => {
                pasteDataContainer.style.display = 'block';
                manualEntryWrapper.style.display = 'none';
                togglePasteBtn.classList.add('active');
                togglePasteBtn.classList.remove('inactive');
                toggleManualBtn.classList.add('inactive');
                toggleManualBtn.classList.remove('active');
            });
            toggleManualBtn.addEventListener('click', () => {
                pasteDataContainer.style.display = 'none';
                manualEntryWrapper.style.display = 'block';
                toggleManualBtn.classList.add('active');
                toggleManualBtn.classList.remove('inactive');
                togglePasteBtn.classList.add('inactive');
                togglePasteBtn.classList.remove('active');
            });

            const resetShuffle = () => { activeVisualShuffleIndices = null; };
            
            // --- SYNC FUNCTIONALITY ---
            dataPaste.addEventListener('input', () => {
                resetShuffle();
                // Parse paste data and populate grid
                const text = dataPaste.value.trim();
                manualDataContainer.innerHTML = '';
                if (text) {
                    text.split('\n').forEach(line => {
                        const parts = line.split('\t');
                        let rawLabel = parts[0] || '';
                        const value = parseItalianNumber(parts[1]);
                        if (rawLabel || !isNaN(value)) {
                            createDataRow(rawLabel, isNaN(value) ? '' : value);
                        }
                    });
                } else {
                     for (let i = 0; i < 5; i++) { createDataRow(); }
                }
            });
            
            const createDataRow = (label = '', value = '') => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'data-row'; 
                
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.className = 'data-label w-2/3';
                labelInput.placeholder = 'Etichetta';
                labelInput.value = label;
                labelInput.addEventListener('input', resetShuffle);
                
                const valueInput = document.createElement('input');
                valueInput.type = 'number';
                valueInput.className = 'data-value w-1/3';
                valueInput.placeholder = '0';
                valueInput.value = value;
                valueInput.addEventListener('input', resetShuffle);
                
                rowDiv.appendChild(labelInput);
                rowDiv.appendChild(valueInput);
                manualDataContainer.appendChild(rowDiv);
            };
            
            addRowBtn.addEventListener('click', () => createDataRow());
            for (let i = 0; i < 5; i++) { createDataRow(); }

            shuffleVisualBtn.addEventListener('click', () => {
                const dataCount = parseData().length;
                if (dataCount > 0) {
                    const indices = Array.from({length: dataCount}, (_, i) => i);
                    for (let i = indices.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [indices[i], indices[j]] = [indices[j], indices[i]];
                    }
                    activeVisualShuffleIndices = indices;
                    generateBtn.click();
                }
            });

            // GESTIONE VISIBILITÀ OPZIONI IN BASE AL TIPO DI GRAFICO
            chartTypeSelectors.forEach(selector => {
                selector.addEventListener('change', (e) => {
                    const val = e.target.value;
                    histogramOptions.style.display = val === 'histogram' ? 'block' : 'none';
                    pieChartOptions.style.display = val === 'pie' ? 'block' : 'none';
                    sentimentBarOptions.style.display = val === 'sentiment_bar' ? 'block' : 'none';
                });
            });
            
            document.getElementById('pie-donut-toggle').addEventListener('change', (e) => document.getElementById('pie-donut-size-container').style.display = e.target.checked ? 'block' : 'none');
            
            pieColorScheme.addEventListener('change', (e) => {
                const scheme = e.target.value;
                document.getElementById('pie-mono-color-container').style.display = scheme === 'mono' ? 'block' : 'none';
                pieTwoColorContainer.style.display = scheme === 'two' ? 'block' : 'none';
                document.getElementById('pie-smart-sort-container').style.display = ['multi', 'mono'].includes(scheme) ? 'flex' : 'none';
                document.getElementById('pie-shuffle-colors-container').style.display = scheme === 'multi' ? 'flex' : 'none';
            });

            fileUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                fileLabel.textContent = `File: ${file.name}`;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    manualDataContainer.innerHTML = '';
                    jsonData.forEach(row => {
                        if(row[0] || row[1]) { createDataRow(row[0] || '', row[1] || ''); }
                    });
                    
                    // Sync to paste area for consistency
                    const text = jsonData.map(row => `${row[0] || ''}\t${row[1] || ''}`).join('\n');
                    dataPaste.value = text;

                    activeVisualShuffleIndices = null; 
                    toggleManualBtn.click(); 
                };
                reader.readAsArrayBuffer(file);
            });
            
            function parseItalianNumber(numStr) {
                if (typeof numStr !== 'string' || !numStr) return 0;
                const cleanedStr = numStr.replace(/\./g, '').replace(/,/g, '.');
                return parseFloat(cleanedStr) || 0;
            }

            function parseData() {
                // Always read from manual data container as it is now synced
                let data = [];
                const dataRows = manualDataContainer.querySelectorAll('.data-row');
                dataRows.forEach(row => {
                    const rawLabel = row.querySelector('.data-label').value.trim();
                    const valueStr = row.querySelector('.data-value').value;
                    
                    if (rawLabel && valueStr) {
                        const value = parseFloat(valueStr) || 0;
                        const highlight = rawLabel.startsWith('*') && rawLabel.endsWith('*');
                        const cleanLabel = highlight ? rawLabel.substring(1, rawLabel.length - 1) : rawLabel;
                        const labelParts = cleanLabel.split('*');
                        data.push({ rawLabel, labelParts, value, highlight });
                    }
                });
                if (data.length === 0) return [];
                return data;
            }

            function formatItalianNumber(num, decimals) {
                if (isNaN(num)) return num;
                const formatSpecifier = `,.${decimals}f`;
                if (Math.abs(num) >= 1_000_000_000) {
                    return itLocale.format(formatSpecifier)(num / 1_000_000_000) + '\u00A0Mld';
                }
                if (Math.abs(num) >= 1_000_000) {
                    return itLocale.format(formatSpecifier)(num / 1_000_000) + '\u00A0M';
                }
                if (Math.abs(num) >= 1_000) {
                    return itLocale.format(formatSpecifier)(num / 1_000) + '\u00A0K';
                }
                return itLocale.format(formatSpecifier)(num);
            }
            
            function formatAxisValueWithOptionalDecimal(num) {
                let value = num;
                let suffix = '';
                let decimals = 0; 
                if (Math.abs(num) >= 1_000_000_000) {
                    value = num / 1_000_000_000;
                    suffix = '\u00A0Mld';
                } else if (Math.abs(num) >= 1_000_000) {
                    value = num / 1_000_000;
                    suffix = '\u00A0M';
                } else if (Math.abs(num) >= 1_000) {
                    value = num / 1_000;
                    suffix = '\u00A0K';
                }
                if (Math.abs(value - Math.round(value)) > 1e-6) {
                   decimals = 1; 
                }
                const formatSpecifier = `,.${decimals}f`;
                return itLocale.format(formatSpecifier)(value) + suffix;
            }

            generateBtn.addEventListener('click', () => {
                const data = parseData();
                if (data.length === 0) {
                    alert('Nessun dato valido trovato. Inserisci almeno un valore.');
                    return;
                }
                
                showButtonFeedback(generateBtn, 'Generazione...');
                chartContainer.innerHTML = '';
                feedbackMessage.textContent = '';
                
                setTimeout(() => {
                    try {
                        const chartType = document.querySelector('input[name="chart_type"]:checked').value;
                        const title = document.getElementById('chart-title').value || 'Grafico';
                        const hideTitle = document.getElementById('hide-title-toggle').checked;
                        const fontSizeTitle = +document.getElementById('font-size-title').value;

                        if (chartType === 'histogram') {
                            const sortBy = document.getElementById('sort-by').value;
                            const sortDirection = document.getElementById('sort-direction').value;
                            if (sortBy !== 'none') {
                                data.sort((a, b) => {
                                    let comparison = (sortBy === 'label') ? a.rawLabel.localeCompare(b.rawLabel) : a.value - b.value;
                                    return sortDirection === 'asc' ? comparison : -comparison;
                                });
                            }
                            const width = +document.getElementById('chart-width').value;
                            const height = +document.getElementById('chart-height').value;
                            const fontSizeX = +document.getElementById('font-size-x').value;
                            const fontSizeY = +document.getElementById('font-size-y').value;
                            const orientation = document.getElementById('chart-orientation').value;
                            const hideValueAxis = document.getElementById('hide-value-axis-toggle').checked;
                            const colorSelect = document.getElementById('histogram-color-scheme');
                            const selectedOption = colorSelect.options[colorSelect.selectedIndex];
                            const mainColor = selectedOption.dataset.main;
                            const highlightColor = selectedOption.dataset.highlight;
                            const barPadding = parseFloat(document.getElementById('histogram-padding').value);

                            drawHistogram(data, title, width, height, fontSizeX, fontSizeY, hideTitle, fontSizeTitle, orientation, mainColor, highlightColor, hideValueAxis, barPadding);

                        } else if (chartType === 'pie') {
                            const isDonut = document.getElementById('pie-donut-toggle').checked;
                            const donutSize = document.getElementById('pie-donut-size').value;
                            const colorSchemeType = pieColorScheme.value;
                            const smartSort = document.getElementById('pie-smart-sort').checked;
                            const shuffleColors = document.getElementById('pie-shuffle-colors').checked;
                            const invertTwoColors = document.getElementById('pie-invert-colors').checked;
                            const labelFormat = document.getElementById('pie-label-format').value;
                            const decimalPlaces = +document.getElementById('pie-decimals').value;
                            const pieFontSizeLabels = +document.getElementById('pie-font-size-labels').value;
                            
                            let renderData = [...data];
                            if (activeVisualShuffleIndices && activeVisualShuffleIndices.length === renderData.length) {
                                renderData = activeVisualShuffleIndices.map(i => data[i]);
                            }
                            drawPieChart(renderData, title, hideTitle, fontSizeTitle, { isDonut, donutSize, colorSchemeType, smartSort, shuffleColors, invertTwoColors, labelFormat, decimalPlaces, pieFontSizeLabels });

                        } else if (chartType === 'sentiment_bar') {
                            const width = +document.getElementById('sentiment-width').value;
                            const barHeight = +document.getElementById('sentiment-height').value;
                            const decimals = +document.getElementById('sentiment-decimals').value;
                            const labelFontSize = +document.getElementById('sentiment-label-font-size').value;

                            drawSentimentBar(data, title, hideTitle, fontSizeTitle, width, barHeight, decimals, labelFontSize);
                        }
                        
                        enableExportButtons();
                        showButtonFeedback(generateBtn, 'Fatto!', true);
                    } catch (error) {
                         console.error("Errore generazione:", error);
                         chartContainer.innerHTML = `<p class="text-red-500 font-semibold p-4 text-center">Errore: ${error.message}</p>`;
                         showButtonFeedback(generateBtn, 'Errore', false, true);
                    }
                }, 100);
            });
            
            function drawCommonTitle(svg, title, isHidden, fontSize) {
                if (isHidden) return 0;
                const titleGroup = svg.append('g').attr('transform', `translate(30, 20)`);
                titleGroup.append('text').attr('x', 0).attr('y', 0).attr('dy', '0.8em').attr('font-family', 'Nunito Sans, sans-serif').attr('font-size', `${fontSize}px`).attr('font-weight', '700').attr('fill', COLORS.titleBlue).text(title);
                titleGroup.append('line').attr('x1', 0).attr('x2', 400).attr('y1', fontSize * 1.1).attr('y2', fontSize * 1.1).attr('stroke', COLORS.titleBlue).attr('stroke-width', 2);
                return fontSize * 1.5 + 40; 
            }
            
            const getSentimentColor = (label) => {
                const l = label.toLowerCase().trim();
                if (l.includes('positivo') || l.includes('positive')) return COLORS.sentiment.positive;
                if (l.includes('neutro') || l.includes('neutral') || l.includes('misto')) return COLORS.sentiment.neutral;
                if (l.includes('negativo') || l.includes('negative')) return COLORS.sentiment.negative;
                return COLORS.sentiment.default;
            };
            
            function drawSentimentLegend(svg, processedData, y, labelFontSize, decimals, containerWidth) {
                // Crea un gruppo temporaneo per calcolare la larghezza totale
                const tempGroup = svg.append('g').attr('visibility', 'hidden');
                let totalWidth = 0;
                
                processedData.forEach(d => {
                    tempGroup.append('circle').attr('cx', totalWidth + 5).attr('cy', 5).attr('r', 6).attr('fill', d.color);
                    const textEl = tempGroup.append('text').attr('x', totalWidth + 18).attr('y', 10).text(`${d.rawLabel} (${itLocale.format(`.${decimals}f`)(d.pct * 100)}%)`).attr('font-size', `${labelFontSize}px`).attr('font-weight', '600');
                    const bbox = textEl.node().getBBox();
                    totalWidth += bbox.width + 35; // 35 padding tra items
                });
                totalWidth -= 20; // rimuovi padding extra finale
                tempGroup.remove();

                // Calcola Start X per centrare
                const startX = (containerWidth - totalWidth) / 2;

                const legendGroup = svg.append('g').attr('transform', `translate(${startX}, ${y})`);
                let legendX = 0;
                processedData.forEach(d => {
                    legendGroup.append('circle').attr('cx', legendX + 5).attr('cy', 5).attr('r', 6).attr('fill', d.color);
                    const textEl = legendGroup.append('text').attr('x', legendX + 18).attr('y', 10).text(`${d.rawLabel} (${itLocale.format(`.${decimals}f`)(d.pct * 100)}%)`).attr('font-size', `${labelFontSize}px`).attr('fill', '#444').attr('font-weight', '600');
                    const bbox = textEl.node().getBBox();
                    legendX += bbox.width + 35; 
                });
            }

            function drawSentimentBar(data, title, hideTitle, fontSizeTitle, width, barHeight, decimals, labelFontSize) {
                let currentY = hideTitle ? 20 : 100;
                const legendPadding = 40;
                const totalHeight = currentY + barHeight + legendPadding + 50; 

                d3.select("#chart-container").html("");
                const svg = d3.select("#chart-container").append("svg")
                    .attr("width", width)
                    .attr("height", totalHeight)
                    .attr("viewBox", `0 0 ${width} ${totalHeight}`)
                    .style("background-color", "transparent");

                const titleOccupiedHeight = drawCommonTitle(svg, title, hideTitle, fontSizeTitle);
                currentY = hideTitle ? 30 : titleOccupiedHeight + 10;

                const totalVal = d3.sum(data, d => d.value);
                let cumulative = 0;
                const processedData = data.map(d => {
                    const pct = (d.value / totalVal);
                    const item = { ...d, color: getSentimentColor(d.rawLabel), pct: pct, start: cumulative, width: pct };
                    cumulative += pct;
                    return item;
                });

                const marginX = 30;
                const chartWidth = width - (marginX * 2);
                
                const barGroup = svg.append('g').attr('transform', `translate(${marginX}, ${currentY})`);
                const xScale = d3.scaleLinear().domain([0, 1]).range([0, chartWidth]);

                processedData.forEach((d, i) => {
                    const rectWidth = xScale(d.width);
                    const xPos = xScale(d.start);
                    const isFirst = i === 0;
                    const isLast = i === processedData.length - 1;
                    const r = 8; 
                    const w = rectWidth;
                    const h = barHeight;
                    
                    const path = d3.path();
                    path.moveTo(isFirst ? r : 0, 0);
                    path.lineTo(isLast ? w - r : w, 0);
                    if (isLast) path.arc(w - r, r, r, -Math.PI/2, 0); else path.lineTo(w, 0);
                    path.lineTo(w, isLast ? h - r : h);
                    if (isLast) path.arc(w - r, h - r, r, 0, Math.PI/2); else path.lineTo(w, h);
                    path.lineTo(isFirst ? r : 0, h);
                    if (isFirst) path.arc(r, h - r, r, Math.PI/2, Math.PI); else path.lineTo(0, h);
                    path.lineTo(0, isFirst ? r : 0);
                    if (isFirst) path.arc(r, r, r, Math.PI, -Math.PI/2);
                    path.closePath();

                    barGroup.append('path').attr('d', path.toString()).attr('transform', `translate(${xPos}, 0)`).attr('fill', d.color).attr('stroke', 'white').attr('stroke-width', 1);
                });

                drawSentimentLegend(svg, processedData, currentY + barHeight + 20, labelFontSize, decimals, width);
            }

            function drawHistogram(data, title, width, height, fontSizeAxis, fontSizeValues, hideTitle, fontSizeTitle, orientation, mainColor, highlightColor, hideValueAxis, barPadding) {
                const addBlueOutline = document.getElementById('histogram-color-scheme').value === 'yellow' && document.getElementById('histogram-yellow-outline').checked;
                const numDecimals = +document.getElementById('histogram-decimals').value;
                const labelWeight = document.getElementById('histogram-label-weight').value;
                
                const svg = d3.select("#chart-container").append("svg").attr("width", width).attr("height", height).attr("viewBox", `0 0 ${width} ${height}`).style("background-color", "transparent");
                const titleHeight = drawCommonTitle(svg, title, hideTitle, fontSizeTitle);
                
                if (orientation === 'horizontal') {
                    // --- HORIZONTAL BAR CHART ---
                    const longestLabel = data.reduce((a, b) => a.rawLabel.length > b.rawLabel.length ? a : b, { rawLabel: '' }).rawLabel;
                    const dynamicLeftMargin = Math.max(100, longestLabel.length * (fontSizeAxis * 0.6));
                    const bottomMargin = hideValueAxis ? 20 : 40; 
                    const margin = { top: titleHeight || 20, right: 80, bottom: bottomMargin, left: dynamicLeftMargin };
                    const innerWidth = width - margin.left - margin.right;
                    const innerHeight = height - margin.top - margin.bottom;
                    if (innerWidth <= 0 || innerHeight <= 0) throw new Error("Spazio insufficiente. Aumenta larghezza/altezza.");
                    
                    const chartGroup = svg.append("g").attr("transform", `translate(${margin.left}, ${margin.top})`);
                    const y = d3.scaleBand().domain(data.map(d => d.rawLabel)).range([0, innerHeight]).padding(barPadding);
                    const x = d3.scaleLinear().domain([0, d3.max(data, d => d.value) * 1.1 || 1]).range([0, innerWidth]);
                    
                    const ticks = x.ticks(5);
                    const formattedTicksInt = ticks.map(d => formatItalianNumber(d, 0));
                    const hasDuplicates = new Set(formattedTicksInt).size < formattedTicksInt.length;
                    const axisTickFormatter = hasDuplicates ? formatAxisValueWithOptionalDecimal : d => formatItalianNumber(d, 0);

                    const grid = chartGroup.append("g").attr("class", "grid").attr("transform", `translate(0, ${innerHeight})`).call(d3.axisBottom(x).ticks(5).tickSize(-innerHeight).tickFormat(""));
                    grid.select(".domain").remove();
                    grid.selectAll("line").attr("stroke", COLORS.gridGray).attr("stroke-width", 0.5);
                    
                    const yAxis = chartGroup.append("g").call(d3.axisLeft(y).tickSize(0));
                    yAxis.select(".domain").remove();
                    
                    yAxis.selectAll(".tick text").attr("dy", null).attr("y", null).text(null).each(function(d) {
                            const dataPoint = data.find(item => item.rawLabel === d);
                            const labelParts = dataPoint ? dataPoint.labelParts : [d];
                            const initialDyOffset = (labelParts.length - 1) / 2;
                            const initialDy = `${0.35 - initialDyOffset * 1.2}em`; 
                            d3.select(this).selectAll("tspan").data(labelParts).enter().append("tspan").attr("x", -5).attr("dy", (part, i) => i === 0 ? initialDy : "1.2em").text(part => part);
                        }).style("font-size", `${fontSizeAxis}px`).style("fill", COLORS.axisGray).style("text-anchor", "end"); 

                    if (!hideValueAxis) {
                        const xAxis = chartGroup.append("g").attr("transform", `translate(0, ${innerHeight})`).call(d3.axisBottom(x).ticks(5).tickSize(0).tickFormat(axisTickFormatter));
                        xAxis.select(".domain").remove();
                        xAxis.selectAll("text").style("font-size", `${fontSizeAxis}px`).style("fill", COLORS.axisGray);
                    }
                    
                    chartGroup.selectAll(".bar").data(data).enter().append("rect").attr("class", "bar").attr("y", d => y(d.rawLabel)).attr("x", 0).attr("height", y.bandwidth()).attr("width", d => x(d.value)).attr("fill", d => d.highlight ? highlightColor : mainColor).attr("stroke", addBlueOutline ? COLORS.titleBlue : 'none').attr("stroke-width", addBlueOutline ? 1 : 0);
                    chartGroup.selectAll(".bar-label").data(data).enter().append("text").attr("class", "bar-label").attr("y", d => y(d.rawLabel) + y.bandwidth() / 2).attr("x", d => x(d.value) + 5).attr("dy", "0.35em").style("font-size", `${fontSizeValues}px`).style("fill", COLORS.titleBlue).style("font-weight", labelWeight).text(d => formatItalianNumber(d.value, numDecimals));
                
                } else { 
                    // --- VERTICAL HISTOGRAM ---
                    const hasIcons = data.some(d => getIconInfo(d.rawLabel) !== null);
                    const axisPadding = hasIcons ? 60 : 30; // Spazio extra per icone
                    
                    const margin = { top: titleHeight || 20, right: 30, bottom: 80 + axisPadding, left: 60 };
                    const innerWidth = width - margin.left - margin.right;
                    const innerHeight = height - margin.top - margin.bottom;
                    
                    if (innerWidth <= 0 || innerHeight <= 0) throw new Error("Spazio insufficiente.");
                    
                    const chartGroup = svg.append("g").attr("transform", `translate(${margin.left}, ${margin.top})`);
                    const x = d3.scaleBand().domain(data.map(d => d.rawLabel)).range([0, innerWidth]).padding(barPadding);
                    const y = d3.scaleLinear().domain([0, d3.max(data, d => d.value) * 1.1 || 1]).range([innerHeight, 0]);
                    
                    const ticks = y.ticks(5);
                    const formattedTicksInt = ticks.map(d => formatItalianNumber(d, 0));
                    const hasDuplicates = new Set(formattedTicksInt).size < formattedTicksInt.length;
                    const axisTickFormatter = hasDuplicates ? formatAxisValueWithOptionalDecimal : d => formatItalianNumber(d, 0);

                    const grid = chartGroup.append("g").attr("class", "grid").call(d3.axisLeft(y).ticks(5).tickSize(-innerWidth).tickFormat(""));
                    grid.select(".domain").remove();
                    grid.selectAll("line").attr("stroke", COLORS.gridGray).attr("stroke-width", 0.5);
                    
                    const yAxis = chartGroup.append("g").call(d3.axisLeft(y).ticks(5).tickSize(0).tickFormat(axisTickFormatter));
                    yAxis.select(".domain").remove();
                    yAxis.selectAll("text").style("font-size", `${fontSizeAxis}px`).style("fill", COLORS.axisGray);

                    // X AXIS - CHECK GLOBAL ROTATION
                    const xAxis = chartGroup.append("g").attr("transform", `translate(0, ${innerHeight})`).call(d3.axisBottom(x).tickSize(0));
                    xAxis.select(".domain").remove();
                    
                    // Logic: Check IF ANY label exceeds width. If so, ALL rotate.
                    let shouldRotateAll = false;
                    const bandWidth = x.bandwidth();

                    xAxis.selectAll(".tick text").each(function(d) {
                         // Measure theoretical width (no icons yet)
                         const tempText = svg.append("text").text(d).style("font-size", `${fontSizeAxis}px`);
                         const w = tempText.node().getComputedTextLength();
                         tempText.remove();
                         if (w > bandWidth + 5) shouldRotateAll = true;
                    });

                    // RENDER LABELS & ICONS
                    xAxis.selectAll(".tick").each(function(d) {
                        const g = d3.select(this);
                        g.selectAll("*").remove(); 
                        
                        const iconInfo = getIconInfo(d);
                        let textY = 25;
                        
                        // 1. Draw Icon
                        if (iconInfo) {
                            g.append("path")
                                .attr("d", iconInfo.path)
                                .attr("transform", `translate(-10, 10) scale(0.8)`) // Smaller scale, shifted
                                .attr("fill", iconInfo.color); 
                            textY = 55; // More space between icon and text
                        }

                        // 2. Draw Text
                        const textElement = g.append("text")
                            .style("font-size", `${fontSizeAxis}px`)
                            .style("fill", COLORS.axisGray)
                            .style("text-anchor", "middle")
                            .text(d);
                        
                        if (shouldRotateAll) {
                             textElement
                                .attr("transform", `translate(0, ${textY}) rotate(-45)`)
                                .style("text-anchor", "end")
                                .attr("dy", "0.5em")
                                .attr("dx", "-0.5em");
                        } else {
                             textElement.attr("y", textY);
                        }
                    });

                    chartGroup.selectAll(".bar").data(data).enter().append("rect").attr("class", "bar").attr("x", d => x(d.rawLabel)).attr("y", d => y(d.value)).attr("width", x.bandwidth()).attr("height", d => innerHeight - y(d.value)).attr("fill", d => d.highlight ? highlightColor : mainColor).attr("stroke", addBlueOutline ? COLORS.titleBlue : 'none').attr("stroke-width", addBlueOutline ? 1 : 0);
                    chartGroup.selectAll(".bar-label").data(data).enter().append("text").attr("class", "bar-label").attr("x", d => x(d.rawLabel) + x.bandwidth() / 2).attr("y", d => y(d.value) - 5).attr("text-anchor", "middle").style("font-size", `${fontSizeValues}px`).style("fill", COLORS.titleBlue).style("font-weight", labelWeight).text(d => formatItalianNumber(d.value, numDecimals));
                }
            }
            
            function drawPieChart(data, title, hideTitle, fontSizeTitle, options) {
                const { isDonut, donutSize, colorSchemeType, smartSort, shuffleColors, invertTwoColors, labelFormat, decimalPlaces, pieFontSizeLabels } = options;
                const labelWeight = document.getElementById('pie-label-weight').value;
                const labelColorChoice = document.getElementById('pie-label-color').value;
                const finalLabelColor = labelColorChoice === 'gray' ? COLORS.labelGray : COLORS.titleBlue;

                d3.select("#chart-container").html("");
                const canvasWidth = 800;
                const isSentimentMode = colorSchemeType === 'sentiment';
                const canvasHeight = isSentimentMode ? 700 : 1100; 

                const radius = isSentimentMode ? 180 : 210;
                const svgContainer = d3.select("#chart-container").append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${canvasWidth} ${canvasHeight}`).attr('preserveAspectRatio', 'xMidYMin meet'); 
                drawCommonTitle(svgContainer, title, hideTitle, fontSizeTitle);
                
                const centerY = isSentimentMode ? (canvasHeight / 2) - 50 : (canvasHeight / 2) + 20;
                const pieGroup = svgContainer.append('g').attr('transform', `translate(${canvasWidth / 2}, ${centerY})`);
                
                let sortedData = [...data];
                if (smartSort && activeVisualShuffleIndices === null && !isSentimentMode) {
                   const tempSorted = [...sortedData].sort((a, b) => b.value - a.value);
                   const reordered = [];
                    let start = 0; let end = tempSorted.length - 1;
                    while(start <= end) {
                        if (start === end) reordered.push(tempSorted[start]);
                        else { reordered.push(tempSorted[start]); reordered.push(tempSorted[end]); }
                        start++; end--;
                    }
                    sortedData = reordered;
                }

                let colorSchemeOrScale;
                if (colorSchemeType === 'sentiment') {
                     colorSchemeOrScale = (val, index) => getSentimentColor(sortedData[index].rawLabel);
                } else if (colorSchemeType === 'two') {
                    const twoColorSelect = document.getElementById('pie-two-color-scheme');
                    const selectedOption = twoColorSelect.options[twoColorSelect.selectedIndex];
                    const mainColor = selectedOption.dataset.main;
                    const highlightColor = selectedOption.dataset.highlight;
                    const colors = invertTwoColors ? [highlightColor, mainColor] : [mainColor, highlightColor];
                    colorSchemeOrScale = colors;
                } else if (colorSchemeType === 'mono') {
                    colorSchemeOrScale = () => document.getElementById('pie-mono-color').value;
                } else {
                    let multiColorScheme = [...COLORS.multiPie];
                    if (shuffleColors) multiColorScheme.sort(() => Math.random() - 0.5);
                    colorSchemeOrScale = multiColorScheme;
                }
                const sizeMap = { stretto: 0.75, medio: 0.6, largo: 0.45 };
                const innerRadius = isDonut ? radius * (sizeMap[donutSize] || 0.6) : 0;
                
                const pie = d3.pie().value(d => d.value).sort(null); 
                const data_ready = pie(sortedData);
                const arc = d3.arc().innerRadius(innerRadius).outerRadius(radius);
                
                pieGroup.selectAll('path').data(data_ready).join('path')
                    .attr('d', arc)
                    .attr('fill', (d, i) => typeof colorSchemeOrScale === 'function' ? colorSchemeOrScale(d.value, i) : colorSchemeOrScale[i % colorSchemeOrScale.length])
                    .style('stroke', 'white').style('stroke-width', '3px');
                
                // SE SENTIMENT MODE: Disegna Legenda
                if (isSentimentMode) {
                    const totalVal = d3.sum(data, d => d.value);
                    const processedData = sortedData.map(d => ({
                        ...d,
                        color: getSentimentColor(d.rawLabel),
                        pct: d.value / totalVal
                    }));
                    // Disegna legenda sotto
                    drawSentimentLegend(svgContainer, processedData, centerY + radius + 80, 20, decimalPlaces, canvasWidth);
                    return; 
                }

                // Standard Labels (Callouts)
                const outerArc = d3.arc().innerRadius(radius * 1.1).outerRadius(radius * 1.1);
                const baseTextRadius = radius * 1.15;
                const farTextRadius = radius * 1.45;
                const minDistance = pieFontSizeLabels + 6; 

                const labels = data_ready.map(d => {
                    const midAngle = (d.startAngle + d.endAngle) / 2;
                    const posOuter = outerArc.centroid(d);
                    const isRight = (midAngle < Math.PI);
                    return {
                        d: d, midAngle: midAngle, y: posOuter[1], xSign: isRight ? 1 : -1, isRight: isRight,
                        radius: baseTextRadius, staggered: false
                    };
                });

                const relaxLabels = (items) => {
                    items.sort((a, b) => a.y - b.y);
                    let iterations = 0; let changed = true;
                    while (changed && iterations < 50) {
                        changed = false; iterations++;
                        for (let i = 0; i < items.length - 1; i++) {
                            const a = items[i]; const b = items[i + 1];
                            const dist = b.y - a.y;
                            if (dist < minDistance) {
                                const overlap = minDistance - dist; const move = overlap / 2;
                                a.y -= move; b.y += move; changed = true;
                                if (!a.staggered && !b.staggered && dist < minDistance * 0.8) {
                                    b.radius = farTextRadius; b.staggered = true;
                                }
                            }
                        }
                    }
                };

                relaxLabels(labels.filter(d => d.isRight));
                relaxLabels(labels.filter(d => !d.isRight));

                pieGroup.selectAll('polyline').data(labels).join('polyline')
                    .attr('points', d => {
                        const start = arc.centroid(d.d);
                        const breakPoint = outerArc.centroid(d.d);
                        const endX = d.radius * d.xSign;
                        return [start, breakPoint, [endX, d.y]];
                    }).style('fill', 'none').attr('stroke', '#444').attr('stroke-width', 1);

                pieGroup.selectAll('text').data(labels).join('text')
                    .attr('transform', d => `translate(${ (d.radius + 10) * d.xSign }, ${d.y})`)
                    .style('text-anchor', d => d.isRight ? 'start' : 'end')
                    .each(function(d) {
                        const el = d3.select(this);
                        const dataItem = d.d.data;
                        const total = d3.sum(data.map(item => item.value));
                        const labelValue = labelFormat === 'percentage'
                            ? itLocale.format(`.${decimalPlaces}f`)(total === 0 ? 0 : (dataItem.value / total * 100)) + '%'
                            : formatItalianNumber(dataItem.value, decimalPlaces);
                        
                        el.selectAll('*').remove();
                        const linesCount = dataItem.labelParts.length + 1;
                        const lineHeight = 1.1; 
                        const startDy = -((linesCount * lineHeight) / 2) + 0.8; 

                        dataItem.labelParts.forEach((part, i) => {
                            el.append('tspan').attr('x', 0).attr('dy', i === 0 ? `${startDy}em` : `${lineHeight}em`)
                                .text(part).style('font-size', `${pieFontSizeLabels}px`).style('font-weight', labelWeight).style('fill', finalLabelColor);
                        });
                        el.append('tspan').attr('x', 0).attr('dy', `${lineHeight}em`).text(labelValue)
                            .style('font-size', `${pieFontSizeLabels - 2}px`).style('font-weight', labelWeight).style('fill', finalLabelColor);
                    });
            }

            function getSettings() {
                const settings = {};
                allInputs.forEach(input => {
                    if (input.id) {
                        settings[input.id] = input.type === 'checkbox' ? input.checked : input.value;
                    }
                });
                settings.manualData = [];
                manualDataContainer.querySelectorAll('.data-row').forEach(row => {
                    const label = row.querySelector('.data-label').value.trim();
                    const value = row.querySelector('.data-value').value;
                    if (label || value) {
                        settings.manualData.push({ label, value });
                    }
                });
                return settings;
            }

            function applySettings(settings) {
                allInputs.forEach(input => {
                    if (input.id && settings[input.id] !== undefined) {
                        if (input.type === 'checkbox') {
                            input.checked = settings[input.id];
                        } else {
                            input.value = settings[input.id];
                        }
                        input.dispatchEvent(new Event('change', { 'bubbles': true }));
                    }
                });
                if (settings.manualData) {
                    manualDataContainer.innerHTML = '';
                    settings.manualData.forEach(row => createDataRow(row.label, row.value));
                     const text = settings.manualData.map(row => `${row.label || ''}\t${row.value || ''}`).join('\n');
                     dataPaste.value = text;
                }
                styleColorSelector('histogram-color-scheme');
                styleColorSelector('pie-two-color-scheme');
            }

            saveSettingsBtn.addEventListener('click', () => {
                const settings = getSettings();
                const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const date = new Date().toISOString().slice(0, 10);
                link.download = `config-grafico-${date}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showButtonFeedback(saveSettingsBtn, 'Salvato!', true);
            });

            loadSettingsInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const settings = JSON.parse(e.target.result);
                        applySettings(settings);
                        showButtonFeedback(document.querySelector('label[for="load-settings-input"]'), 'OK!', true);
                    } catch (err) {
                        showButtonFeedback(document.querySelector('label[for="load-settings-input"]'), 'Err', false, true);
                    }
                };
                reader.readAsText(file);
                loadSettingsInput.value = '';
            });

            function getSvgString() {
                const svgNode = chartContainer.querySelector('svg');
                if (!svgNode) return null;
                const clone = svgNode.cloneNode(true);
                clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                return new XMLSerializer().serializeToString(clone);
            }
            downloadBtn.addEventListener('click', () => {
                 const svgString = getSvgString();
                if (!svgString) return;
                const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = (document.getElementById('chart-title').value || 'grafico') + '.svg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            });
            function enableExportButtons() {
                downloadBtn.disabled = false;
                downloadBtn.classList.replace('bg-gray-300', 'brand-blue');
                downloadBtn.classList.remove('cursor-not-allowed');
            }
            function showButtonFeedback(button, message, success = false, isError = false) {
                 const originalText = button.textContent;
                 const originalClasses = button.className;
                 button.textContent = message;
                 if (isError) button.className = 'w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-md';
                 else if (success) button.className = 'w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-md';
                 setTimeout(() => { button.textContent = originalText; button.className = originalClasses; }, 2000);
            }
        });
    </script>
</body>
</html>
