<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Grafici</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js for chart generation -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- SheetJS (xlsx) for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Fonts: Nunito Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to match the branding */
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: #f0f2f5; /* Light grey background */
        }
        .brand-yellow {
            background-color: #ffc72c;
        }
        .brand-blue {
            background-color: #0431AE;
        }
        .text-brand-blue {
            color: #0431AE;
        }
        .border-brand-blue {
            border-color: #0431AE;
        }
        /* Custom radio button styles */
        .custom-radio input[type="radio"] {
            display: none;
        }
        .custom-radio label {
            transition: all 0.2s ease-in-out;
        }
        .custom-radio input[type="radio"]:checked + label {
            border-color: #0431AE;
            background-color: #e0e7ff;
            color: #0431AE;
            font-weight: 700;
        }
        /* SVG text selection */
        svg text {
             user-select: none;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <header class="brand-yellow p-4 shadow-md">
        <h1 class="text-3xl font-bold text-brand-blue text-center">Generatore Grafici</h1>
    </header>

    <main class="container mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Controls Column -->
        <div class="lg:col-span-4 bg-white p-6 rounded-lg shadow-lg h-fit">
            
            <!-- 1. Chart Type Selection -->
            <div class="mb-6">
                <h2 class="text-xl font-bold text-brand-blue mb-3">1. Seleziona tipo di grafico</h2>
                <div class="grid grid-cols-2 gap-4 custom-radio">
                    <div>
                        <input type="radio" id="histogram" name="chart_type" value="histogram" checked class="chart-type-selector">
                        <label for="histogram" class="cursor-pointer border-2 border-gray-200 rounded-lg p-4 text-center block hover:border-blue-400">Istogramma</label>
                    </div>
                    <div>
                        <input type="radio" id="pie_chart" name="chart_type" value="pie" class="chart-type-selector">
                        <label for="pie_chart" class="cursor-pointer border-2 border-gray-200 rounded-lg p-4 text-center block hover:border-blue-400">Grafico a Torta</label>
                    </div>
                </div>
            </div>

            <!-- 2. Data Loading -->
            <div class="mb-6">
                <h2 class="text-xl font-bold text-brand-blue mb-3">2. Carica i dati</h2>
                <div class="space-y-4">
                    <div>
                        <label for="chart-title" class="block text-sm font-medium text-gray-700 mb-1">Titolo del Grafico</label>
                        <input type="text" id="chart-title" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Es. Interazioni Mensili">
                    </div>
                    <div class="flex items-center">
                        <input id="hide-title-toggle" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="hide-title-toggle" class="ml-2 block text-sm text-gray-900">Nascondi titolo</label>
                    </div>
                    <div>
                        <label for="data-paste" class="block text-sm font-medium text-gray-700 mb-1">Incolla dati (Label [TAB] Valore)</label>
                        <textarea id="data-paste" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Servizi*Finanziari	150&#10;Febbraio	200&#10;*Marzo*	120"></textarea>
                    </div>
                    <div class="text-center text-gray-500">oppure</div>
                    <div>
                        <label for="file-upload" class="w-full inline-block text-center px-4 py-2 border border-dashed border-gray-400 rounded-md cursor-pointer hover:bg-gray-50">
                            <span id="file-label">Carica file Excel (.xlsx)</span>
                            <input type="file" id="file-upload" class="hidden" accept=".xlsx, .xls">
                        </label>
                    </div>
                </div>
            </div>

            <!-- Histogram Specific Options -->
            <div id="histogram-options" class="mb-6">
                <h3 class="text-lg font-bold text-brand-blue mb-3">Opzioni Istogramma</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="chart-width" class="block text-sm font-medium text-gray-700">Larghezza (px)</label>
                        <input type="number" id="chart-width" value="800" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="chart-height" class="block text-sm font-medium text-gray-700">Altezza (px)</label>
                        <input type="number" id="chart-height" value="500" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4">
                     <div>
                        <label for="font-size-x" class="block text-sm font-medium text-gray-700">Font Asse X (px)</label>
                        <input type="number" id="font-size-x" value="12" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="font-size-y" class="block text-sm font-medium text-gray-700">Font Asse Y (px)</label>
                        <input type="number" id="font-size-y" value="10" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="sort-by" class="block text-sm font-medium text-gray-700">Ordina per</label>
                        <select id="sort-by" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="none" selected>Nessun ordine (default)</option>
                            <option value="label">Etichetta (Col A)</option>
                            <option value="value">Valore (Col B)</option>
                        </select>
                    </div>
                    <div>
                        <label for="sort-direction" class="block text-sm font-medium text-gray-700">Direzione</label>
                        <select id="sort-direction" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="asc">Crescente (A-Z, 0-9)</option>
                            <option value="desc" selected>Decrescente (Z-A, 9-0)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Pie Chart Specific Options -->
            <div id="pie-chart-options" class="mb-6" style="display: none;">
                <h3 class="text-lg font-bold text-brand-blue mb-3">Opzioni Grafico a Torta</h3>
                <div class="space-y-4">
                    <div class="flex items-center">
                        <input id="pie-donut-toggle" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="pie-donut-toggle" class="ml-2 block text-sm text-gray-900">Grafico ad anello</label>
                    </div>
                    <div id="pie-donut-size-container" style="display: none;">
                        <label for="pie-donut-size" class="block text-sm font-medium text-gray-700">Spessore Anello</label>
                        <select id="pie-donut-size" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="stretto">Stretto</option>
                            <option value="medio" selected>Medio</option>
                            <option value="largo">Largo</option>
                        </select>
                    </div>
                    <div>
                        <label for="pie-color-scheme" class="block text-sm font-medium text-gray-700">Schema Colori</label>
                        <select id="pie-color-scheme" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="multi" selected>Multi Colore</option>
                            <option value="two">2 Colori</option>
                            <option value="sentiment">Sentiment</option>
                        </select>
                    </div>
                    <div id="pie-smart-sort-container" class="flex items-center">
                        <input id="pie-smart-sort" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="pie-smart-sort" class="ml-2 block text-sm text-gray-900">Alterna valori per etichette</label>
                    </div>
                    <div id="pie-invert-colors-container" class="flex items-center" style="display: none;">
                        <input id="pie-invert-colors" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="pie-invert-colors" class="ml-2 block text-sm text-gray-900">Inverti 2 Colori</label>
                    </div>
                    <div>
                        <label for="pie-label-format" class="block text-sm font-medium text-gray-700">Formato Etichette</label>
                        <select id="pie-label-format" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="percentage" selected>Percentuale</option>
                            <option value="absolute">Valore Assoluto</option>
                        </select>
                    </div>
                    <div id="pie-decimals-container">
                        <label for="pie-decimals" class="block text-sm font-medium text-gray-700">Numero Decimali</label>
                        <select id="pie-decimals" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="0">0</option>
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                     <div class="grid grid-cols-2 gap-4 pt-2">
                        <div>
                            <label for="pie-font-size-title" class="block text-sm font-medium text-gray-700">Font Titolo (px)</label>
                            <input type="number" id="pie-font-size-title" value="32" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="pie-font-size-labels" class="block text-sm font-medium text-gray-700">Font Etichette (px)</label>
                            <input type="number" id="pie-font-size-labels" value="28" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>
            </div>


            <!-- 3. Chart Generation & Settings -->
            <div>
                 <h2 class="text-xl font-bold text-brand-blue mb-3">3. Azioni</h2>
                 <div class="flex flex-col space-y-3">
                    <button id="generate-btn" class="w-full brand-blue text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-opacity">
                        Genera Grafico
                    </button>
                    <button id="download-btn" disabled class="w-full bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed">
                        Scarica SVG
                    </button>
                    <button id="copy-btn" disabled class="w-full bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed">
                        Copia Grafico
                    </button>
                    <hr class="my-2">
                    <button id="save-settings-btn" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors">
                        Salva Impostazioni
                    </button>
                    <label for="load-settings-input" class="w-full text-center bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer">
                        Carica Impostazioni
                        <input type="file" id="load-settings-input" class="hidden" accept=".json">
                    </label>
                 </div>
            </div>
        </div>

        <!-- Chart Preview Column -->
        <div class="lg:col-span-8 bg-white p-4 md:p-6 rounded-lg shadow-lg flex flex-col items-center justify-center min-h-[500px]">
            <div id="chart-container" class="w-full h-full flex items-center justify-center">
                <div class="text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    <p class="mt-2">L'anteprima del grafico apparirà qui.</p>
                </div>
            </div>
             <p id="feedback-message" class="mt-4 text-green-600 font-semibold"></p>
        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chartTypeSelectors = document.querySelectorAll('.chart-type-selector');
            const histogramOptions = document.getElementById('histogram-options');
            const pieChartOptions = document.getElementById('pie-chart-options');
            const generateBtn = document.getElementById('generate-btn');
            const downloadBtn = document.getElementById('download-btn');
            const copyBtn = document.getElementById('copy-btn');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const loadSettingsInput = document.getElementById('load-settings-input');
            const chartContainer = document.getElementById('chart-container');
            const fileUpload = document.getElementById('file-upload');
            const dataPaste = document.getElementById('data-paste');
            const fileLabel = document.getElementById('file-label');
            const feedbackMessage = document.getElementById('feedback-message');
            const pieDonutToggle = document.getElementById('pie-donut-toggle');
            const pieDonutSizeContainer = document.getElementById('pie-donut-size-container');
            const pieColorScheme = document.getElementById('pie-color-scheme');
            const pieInvertColorsContainer = document.getElementById('pie-invert-colors-container');
            const pieSmartSortContainer = document.getElementById('pie-smart-sort-container');
            const pieLabelFormat = document.getElementById('pie-label-format');
            const pieDecimalsContainer = document.getElementById('pie-decimals-container');


            const COLORS = {
                titleBlue: '#0431AE',
                barBlue: '#bfd7fd',
                axisGray: '#7b7b7a',
                gridGray: '#e0e0e0',
                sentiment: {
                    positive: '#28a745', // green
                    neutral: '#ffc107', // yellow
                    negative: '#dc3545', // red
                },
                multiPie: [
                    '#0d47a1', '#1565c0', '#1976d2', '#1e88e5', '#2196f3',
                    '#42a5f5', '#64b5f6', '#90caf9', '#bbdefb', '#e3f2fd'
                ]
            };

            // Toggle chart options visibility
            chartTypeSelectors.forEach(selector => {
                selector.addEventListener('change', (e) => {
                    const isHistogram = e.target.value === 'histogram';
                    histogramOptions.style.display = isHistogram ? 'block' : 'none';
                    pieChartOptions.style.display = !isHistogram ? 'block' : 'none';
                });
            });

            // Toggle conditional pie chart options
            pieDonutToggle.addEventListener('change', () => {
                pieDonutSizeContainer.style.display = pieDonutToggle.checked ? 'block' : 'none';
            });
            pieColorScheme.addEventListener('change', () => {
                pieInvertColorsContainer.style.display = pieColorScheme.value === 'two' ? 'flex' : 'none';
                pieSmartSortContainer.style.display = pieColorScheme.value === 'multi' ? 'flex' : 'none';
            });
            pieLabelFormat.addEventListener('change', () => {
                pieDecimalsContainer.style.display = pieLabelFormat.value === 'percentage' ? 'block' : 'none';
            });


            // Handle file upload
            fileUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                fileLabel.textContent = `Caricato: ${file.name}`;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    const tsvData = jsonData.map(row => row.join('\t')).join('\n');
                    dataPaste.value = tsvData;
                };
                reader.readAsArrayBuffer(file);
            });
            
            // --- DATA PARSING ---
            function parseData() {
                const text = dataPaste.value.trim();
                if (!text) {
                    alert('Per favore, inserisci dei dati.');
                    return [];
                }
                return text.split('\n').map(line => {
                    const parts = line.split('\t');
                    let rawLabel = parts[0] || '';
                    const value = parseFloat(parts[1]) || 0;
                    
                    let cleanLabel = rawLabel;
                    const highlight = rawLabel.startsWith('*') && rawLabel.endsWith('*');
                    if (highlight) {
                        cleanLabel = rawLabel.substring(1, rawLabel.length - 1);
                    }

                    const labelParts = cleanLabel.split('*');

                    return { rawLabel, labelParts, value, highlight };
                }).filter(d => d.rawLabel && !isNaN(d.value));
            }

            // --- CHART GENERATION LOGIC ---
            generateBtn.addEventListener('click', () => {
                const data = parseData();
                const chartType = document.querySelector('input[name="chart_type"]:checked').value;
                const title = document.getElementById('chart-title').value || 'Grafico';
                const hideTitle = document.getElementById('hide-title-toggle').checked;

                if (data.length === 0) return;
                
                showButtonFeedback(generateBtn, 'Generazione...');
                
                chartContainer.innerHTML = ''; // Clear previous chart
                feedbackMessage.textContent = '';
                
                setTimeout(() => {
                    try {
                        switch (chartType) {
                            case 'histogram':
                                const sortBy = document.getElementById('sort-by').value;
                                const sortDirection = document.getElementById('sort-direction').value;

                                if (sortBy !== 'none') {
                                    data.sort((a, b) => {
                                        let comparison = 0;
                                        if (sortBy === 'label') {
                                            comparison = a.rawLabel.localeCompare(b.rawLabel);
                                        } else { // sortBy === 'value'
                                            comparison = a.value - b.value;
                                        }
                                        return sortDirection === 'asc' ? comparison : -comparison;
                                    });
                                }
                                const width = +document.getElementById('chart-width').value;
                                const height = +document.getElementById('chart-height').value;
                                const fontSizeX = +document.getElementById('font-size-x').value;
                                const fontSizeY = +document.getElementById('font-size-y').value;
                                drawHistogram(data, title, width, height, fontSizeX, fontSizeY, hideTitle);
                                break;
                            case 'pie':
                                const isDonut = document.getElementById('pie-donut-toggle').checked;
                                const donutSize = document.getElementById('pie-donut-size').value;
                                const colorSchemeType = document.getElementById('pie-color-scheme').value;
                                const smartSort = document.getElementById('pie-smart-sort').checked;
                                const invertTwoColors = document.getElementById('pie-invert-colors').checked;
                                const labelFormat = document.getElementById('pie-label-format').value;
                                const decimalPlaces = +document.getElementById('pie-decimals').value;
                                const pieFontSizeTitle = +document.getElementById('pie-font-size-title').value;
                                const pieFontSizeLabels = +document.getElementById('pie-font-size-labels').value;
                                let colorScheme;
                                let sortedData = [...data];

                                if (colorSchemeType === 'sentiment') {
                                    const sentimentOrder = ['Positivo', 'Neutro', 'Negativo'];
                                    sortedData.sort((a, b) => sentimentOrder.indexOf(a.labelParts.join(' ')) - sentimentOrder.indexOf(b.labelParts.join(' ')));
                                    colorScheme = sortedData.map(d => {
                                        const labelLower = d.labelParts.join(' ').toLowerCase();
                                        if (labelLower === 'positivo') return COLORS.sentiment.positive;
                                        if (labelLower === 'neutro') return COLORS.sentiment.neutral;
                                        if (labelLower === 'negativo') return COLORS.sentiment.negative;
                                        return 'gray';
                                    });
                                } else if (colorSchemeType === 'two') {
                                    colorScheme = [COLORS.titleBlue, COLORS.barBlue];
                                    if (invertTwoColors) colorScheme.reverse();
                                } else { // multi
                                    colorScheme = COLORS.multiPie;
                                    if (smartSort) {
                                        const tempSorted = [...sortedData].sort((a, b) => b.value - a.value);
                                        const reordered = [];
                                        let left = 0, right = tempSorted.length - 1;
                                        while (left <= right) {
                                            if (left <= right) reordered.push(tempSorted[left++]);
                                            if (left <= right) reordered.push(tempSorted[right--]);
                                        }
                                        sortedData = reordered;
                                    }
                                }
                                drawPieChart(sortedData, title, colorScheme, isDonut, donutSize, labelFormat, decimalPlaces, hideTitle, pieFontSizeTitle, pieFontSizeLabels);
                                break;
                        }
                        
                        enableExportButtons();
                        showButtonFeedback(generateBtn, 'Fatto!', true);
                    } catch (error) {
                         console.error("Errore durante la generazione del grafico:", error);
                         chartContainer.innerHTML = `<p class="text-red-500">Si è verificato un errore. Controlla i dati e riprova.</p>`;
                         showButtonFeedback(generateBtn, 'Errore', false, true);
                    }
                }, 200); // Small delay for UX
            });
            
            // --- DRAWING FUNCTIONS (D3.js) ---

            function drawCommonTitle(svg, title, isHidden, fontSize = 32) {
                if (isHidden) return;
                const textEl = svg.append('text')
                    .attr('x', 0)
                    .attr('y', fontSize) // Adjust y based on font size
                    .attr('font-family', 'Nunito Sans, sans-serif')
                    .attr('font-size', `${fontSize}px`)
                    .attr('font-weight', '700')
                    .attr('fill', COLORS.titleBlue)
                    .text(title);
                
                const textHeight = textEl.node().getBBox().height;

                svg.append('line')
                    .attr('x1', 0)
                    .attr('x2', 400) // Fixed length, can be dynamic
                    .attr('y1', fontSize + textHeight * 0.2)
                    .attr('y2', fontSize + textHeight * 0.2)
                    .attr('stroke', COLORS.titleBlue)
                    .attr('stroke-width', 2);
            }

            function drawHistogram(data, title, width, height, fontSizeX, fontSizeY, hideTitle) {
                const titleMargin = hideTitle ? 20 : 80;
                const longestLabel = data.reduce((a, b) => (a.rawLabel.length > b.rawLabel.length ? a : b), { rawLabel: '' }).rawLabel;
                const dynamicBottomMargin = Math.max(80, longestLabel.length * fontSizeX * 0.55);
                const margin = { top: titleMargin, right: 30, bottom: dynamicBottomMargin, left: 60 };
                const innerWidth = width - margin.left - margin.right;
                const innerHeight = height - margin.top - margin.bottom;
                const svg = d3.select("#chart-container").append("svg").attr("width", width).attr("height", height).attr("viewBox", `0 0 ${width} ${height}`).style("background-color", "transparent");
                drawCommonTitle(svg, title, hideTitle, 32);
                const g = svg.append("g").attr("transform", `translate(${margin.left}, ${margin.top})`);
                const x = d3.scaleBand().domain(data.map(d => d.rawLabel)).range([0, innerWidth]).padding(0.4);
                const y = d3.scaleLinear().domain([0, d3.max(data, d => d.value) * 1.1 || 1]).range([innerHeight, 0]);
                g.append("g").attr("class", "grid").call(d3.axisLeft(y).ticks(5).tickSize(-innerWidth).tickFormat("")).selectAll("line").attr("stroke", COLORS.gridGray).attr("stroke-dasharray", "2,2");
                g.select(".domain").remove();
                
                const xAxis = g.append("g")
                    .attr("transform", `translate(0, ${innerHeight})`)
                    .call(d3.axisBottom(x));

                xAxis.selectAll(".tick text")
                    .text(null) // Remove default text
                    .each(function(d) { // d is the rawLabel
                        const dataPoint = data.find(item => item.rawLabel === d);
                        const labelParts = dataPoint ? dataPoint.labelParts : [d];
                        const tick = d3.select(this);
                        labelParts.forEach((part, i) => {
                            tick.append("tspan")
                                .attr("x", 0)
                                .attr("dy", i === 0 ? 0 : "1.2em")
                                .text(part);
                        });
                    });
                
                xAxis.selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-45)")
                    .style("font-size", `${fontSizeX}px`)
                    .style("fill", COLORS.axisGray);

                g.append("g").call(d3.axisLeft(y).ticks(5)).style("font-size", `${fontSizeY}px`).style("color", COLORS.axisGray);
                g.selectAll(".bar").data(data).enter().append("rect").attr("class", "bar").attr("x", d => x(d.rawLabel)).attr("y", d => y(d.value)).attr("width", x.bandwidth()).attr("height", d => innerHeight - y(d.value)).attr("fill", d => d.highlight ? COLORS.titleBlue : COLORS.barBlue);
                g.selectAll(".bar-label").data(data).enter().append("text").attr("class", "bar-label").attr("x", d => x(d.rawLabel) + x.bandwidth() / 2).attr("y", d => y(d.value) - 5).attr("text-anchor", "middle").style("font-size", `${fontSizeX}px`).style("fill", COLORS.titleBlue).style("font-weight", "900").text(d => d3.format(".2s")(d.value).replace('G', 'B'));
            }

            function drawPieChart(data, title, colorScheme, isDonut, donutSize, labelFormat, decimalPlaces, hideTitle, fontSizeTitle, fontSizeLabels) {
                const width = 1200;
                const height = 1200;
                const radius = Math.min(width, height) / 3.6; // Raggio ridotto per più spazio
                
                const sizeMap = { stretto: 0.75, medio: 0.6, largo: 0.45 };
                const donutRatio = sizeMap[donutSize] || 0.6; // Default to medio
                const innerRadius = isDonut ? radius * donutRatio : 0;
                
                const svgContainer = d3.select("#chart-container")
                    .append("svg")
                    .attr("width", "100%")
                    .attr("height", "100%")
                    .attr("viewBox", `0 0 ${width} ${height}`)
                    .style("background-color", "transparent");
                    
                const svg = svgContainer.append("g")
                    .attr("transform", `translate(${width / 2}, ${height / 2})`);

                drawCommonTitle(svgContainer, title, hideTitle, fontSizeTitle);

                const color = d3.scaleOrdinal().range(colorScheme);
                const pie = d3.pie().value(d => d.value).sort(null);
                const data_ready = pie(data);

                const arc = d3.arc().innerRadius(innerRadius).outerRadius(radius);

                svg.selectAll('allSlices')
                    .data(data_ready)
                    .enter()
                    .append('path')
                    .attr('d', arc)
                    .style('stroke-width', '2px');

                const outerArc = d3.arc()
                    .innerRadius(radius * 1.1)
                    .outerRadius(radius * 1.1);

                svg.selectAll('allPolylines')
                    .data(data_ready)
                    .enter()
                    .append('polyline')
                    .attr('stroke', '#444')
                    .style('fill', 'none')
                    .attr('stroke-width', 1)
                    .attr('points', d => {
                        const posA = arc.centroid(d);
                        const posB = outerArc.centroid(d);
                        const posC = [posB[0], posB[1]];
                        const midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                        posC[0] = radius * 1.15 * (midangle < Math.PI ? 1 : -1); // Shorter line
                        return [posA, posB, posC];
                    });

                svg.selectAll('allLabels')
                    .data(data_ready)
                    .enter()
                    .append('text')
                    .attr('transform', d => {
                        const pos = outerArc.centroid(d);
                        const midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                        pos[0] = radius * 1.20 * (midangle < Math.PI ? 1 : -1); // Position text after shorter line
                        return `translate(${pos})`;
                    })
                    .style('text-anchor', d => {
                        const midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                        return (midangle < Math.PI ? 'start' : 'end');
                    })
                    .each(function(d) {
                        const el = d3.select(this);
                        const labelParts = d.data.labelParts;

                        let labelValue;
                        if (labelFormat === 'percentage') {
                            const total = d3.sum(data.map(item => item.value));
                            const percentage = total === 0 ? 0 : (d.data.value / total * 100);
                            labelValue = percentage.toFixed(decimalPlaces) + '%';
                        } else {
                            labelValue = d3.format(",")(d.data.value);
                        }

                        labelParts.forEach((part, i) => {
                             el.append('tspan')
                                .attr('x', 0)
                                .attr('dy', i === 0 ? 0 : '1.2em')
                                .text(part)
                                .style('font-size', `${fontSizeLabels}px`)
                                .style('font-weight', '700')
                                .style('fill', COLORS.titleBlue)
                                .style('font-family', 'Nunito Sans, sans-serif');
                        });
                       
                        el.append('tspan')
                            .attr('x', 0)
                            .attr('dy', '1.2em')
                            .text(labelValue)
                            .style('font-size', `${fontSizeLabels - 2}px`)
                            .style('font-weight', '400')
                            .style('fill', COLORS.titleBlue)
                            .style('font-family', 'Nunito Sans, sans-serif');
                    });

                svg.selectAll('path').attr('fill', (d, i) => {
                    if (Array.isArray(colorScheme)) {
                       return colorScheme[i % colorScheme.length];
                    }
                    return color(d.data.rawLabel);
                });
            }

            // --- SETTINGS IMPORT/EXPORT ---
            function getSettings() {
                const settings = {
                    chartType: document.querySelector('input[name="chart_type"]:checked').value,
                    chartTitle: document.getElementById('chart-title').value,
                    hideTitle: document.getElementById('hide-title-toggle').checked,
                };
                if (settings.chartType === 'histogram') {
                    settings.histogram = {
                        width: document.getElementById('chart-width').value,
                        height: document.getElementById('chart-height').value,
                        fontSizeX: document.getElementById('font-size-x').value,
                        fontSizeY: document.getElementById('font-size-y').value,
                        sortBy: document.getElementById('sort-by').value,
                        sortDirection: document.getElementById('sort-direction').value
                    };
                } else if (settings.chartType === 'pie') {
                    settings.pie = {
                        isDonut: document.getElementById('pie-donut-toggle').checked,
                        donutSize: document.getElementById('pie-donut-size').value,
                        colorScheme: document.getElementById('pie-color-scheme').value,
                        smartSort: document.getElementById('pie-smart-sort').checked,
                        invertColors: document.getElementById('pie-invert-colors').checked,
                        labelFormat: document.getElementById('pie-label-format').value,
                        decimalPlaces: document.getElementById('pie-decimals').value,
                        fontSizeTitle: document.getElementById('pie-font-size-title').value,
                        fontSizeLabels: document.getElementById('pie-font-size-labels').value
                    };
                }
                return settings;
            }

            function applySettings(settings) {
                document.querySelector(`input[name="chart_type"][value="${settings.chartType}"]`).checked = true;
                document.getElementById('chart-title').value = settings.chartTitle || '';
                document.getElementById('hide-title-toggle').checked = settings.hideTitle || false;


                const chartChangeEvent = new Event('change');
                document.querySelector(`input[name="chart_type"][value="${settings.chartType}"]`).dispatchEvent(chartChangeEvent);

                if (settings.chartType === 'histogram' && settings.histogram) {
                    document.getElementById('chart-width').value = settings.histogram.width || 800;
                    document.getElementById('chart-height').value = settings.histogram.height || 500;
                    document.getElementById('font-size-x').value = settings.histogram.fontSizeX || 12;
                    document.getElementById('font-size-y').value = settings.histogram.fontSizeY || 10;
                    document.getElementById('sort-by').value = settings.histogram.sortBy || 'none';
                    document.getElementById('sort-direction').value = settings.histogram.sortDirection || 'desc';
                } else if (settings.chartType === 'pie' && settings.pie) {
                    document.getElementById('pie-donut-toggle').checked = settings.pie.isDonut || false;
                    document.getElementById('pie-donut-size').value = settings.pie.donutSize || 'medio';
                    document.getElementById('pie-color-scheme').value = settings.pie.colorScheme || 'multi';
                    document.getElementById('pie-smart-sort').checked = settings.pie.smartSort || false;
                    document.getElementById('pie-invert-colors').checked = settings.pie.invertColors || false;
                    document.getElementById('pie-label-format').value = settings.pie.labelFormat || 'percentage';
                    document.getElementById('pie-decimals').value = settings.pie.decimalPlaces || '1';
                    document.getElementById('pie-font-size-title').value = settings.pie.fontSizeTitle || '32';
                    document.getElementById('pie-font-size-labels').value = settings.pie.fontSizeLabels || '28';

                    
                    const pieChangeEvent = new Event('change');
                    document.getElementById('pie-donut-toggle').dispatchEvent(pieChangeEvent);
                    document.getElementById('pie-color-scheme').dispatchEvent(pieChangeEvent);
                    document.getElementById('pie-label-format').dispatchEvent(pieChangeEvent);
                }
                 showFeedbackMessage('Impostazioni caricate con successo.');
            }

            saveSettingsBtn.addEventListener('click', () => {
                const settings = getSettings();
                const settingsString = JSON.stringify(settings, null, 2);
                const blob = new Blob([settingsString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const today = new Date().toISOString().slice(0, 10);
                const filename = (settings.chartTitle || 'impostazioni_grafico').replace(/\s+/g, '_');
                link.download = `${filename}_${today}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showFeedbackMessage('File impostazioni salvato.');
            });

            loadSettingsInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const settings = JSON.parse(e.target.result);
                        applySettings(settings);
                    } catch(error) {
                        console.error("Errore nel parsing del file impostazioni:", error);
                        showFeedbackMessage('Errore: file non valido.');
                    }
                };
                reader.readAsText(file);
                loadSettingsInput.value = ''; 
            });


            // --- EXPORT FUNCTIONS ---
            function getSvgString() {
                const svgNode = chartContainer.querySelector('svg');
                if (!svgNode) return null;
                const clone = svgNode.cloneNode(true);
                clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                return new XMLSerializer().serializeToString(clone);
            }

            downloadBtn.addEventListener('click', () => {
                const svgString = getSvgString();
                if (!svgString) return;
                const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = (document.getElementById('chart-title').value || 'grafico') + '.svg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showFeedbackMessage('Grafico scaricato come SVG.');
            });

            copyBtn.addEventListener('click', () => {
                const svgString = getSvgString();
                if (!svgString) return;
                showButtonFeedback(copyBtn, 'Copiando...');
                const blob = new Blob([svgString], { type: 'image/svg+xml' });
                 if (typeof ClipboardItem === "undefined") {
                    navigator.clipboard.writeText(svgString).then(() => {
                        showButtonFeedback(copyBtn, 'Copiato (testo SVG)!', true);
                        showFeedbackMessage('Codice SVG copiato negli appunti.');
                    }, () => {
                        showButtonfeedback(copyBtn, 'Copia Fallita', false, true);
                        showFeedbackMessage('Errore durante la copia.');
                    });
                    return;
                }
                const item = new ClipboardItem({ 'image/svg+xml': blob });
                navigator.clipboard.write([item]).then(() => {
                     showButtonFeedback(copyBtn, 'Copiato!', true);
                     showFeedbackMessage('Grafico copiato. Prova a incollarlo in PowerPoint.');
                }).catch(err => {
                    console.error('Could not copy image: ', err);
                    showButtonFeedback(copyBtn, 'Copia Fallita', false, true);
                    showFeedbackMessage('Errore durante la copia. Il tuo browser potrebbe non supportare questa funzione.');
                });
            });

            function enableExportButtons() {
                downloadBtn.disabled = false;
                downloadBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                downloadBtn.classList.add('brand-blue', 'text-white', 'hover:opacity-90');

                copyBtn.disabled = false;
                copyBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                copyBtn.classList.add('brand-blue', 'text-white', 'hover:opacity-90');
            }
            
            function showButtonFeedback(button, message, success = false, isError = false) {
                 const originalText = button.textContent;
                 const originalClasses = button.className;
                 button.textContent = message;
                 if (isError) {
                     button.className = 'w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition-all';
                 } else if (success) {
                     button.className = 'w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition-all';
                 }
                 setTimeout(() => {
                     button.textContent = originalText;
                     button.className = originalClasses;
                 }, 2000);
            }

            function showFeedbackMessage(message) {
                feedbackMessage.textContent = message;
                setTimeout(() => {
                    feedbackMessage.textContent = '';
                }, 3000);
            }
        });
    </script>
</body>
</html>

